# Phase 2 코드 리뷰 수정

**일시**: 2026-02-27
**단계**: Phase 2 - CodeRabbit 리뷰 피드백 반영

---

## 수정 항목

### Critical (4건)

#### 1. RLS 정책 보안 강화
- `bot_logs`, `click_logs` INSERT 정책에 `TO service_role` 추가
- 기존: `WITH CHECK (true)` → anon key로 누구나 INSERT 가능
- 수정: `TO service_role WITH CHECK (true)` → service_role만 INSERT 가능

#### 2. Supabase 환경변수 방어
- `utils/supabase.ts`: non-null assertion(`!`) 제거, 누락 시 `throw Error`
- 앱 시작 시 환경변수 없으면 즉시 실패하도록 변경

#### 3. API 에러 메시지 노출 차단
- `routes/api/products.ts`: Supabase 에러 메시지를 클라이언트에 직접 노출하지 않음
- `console.error`로 서버 로그 + 사용자에게는 일반 에러 메시지 반환

#### 4. 스크립트 환경변수 검증
- `check-tables.ts`, `seed-data.ts`, `create-schema.ts`, `test-query.ts` 모두 환경변수 검증 추가
- 누락 시 명확한 에러 메시지와 함께 `Deno.exit(1)`

### High (4건)

#### 5. JSON-LD XSS 방어
- `safeJsonLd()` 함수 추가: `</script>` 탈출 공격 방지
- `JSON.stringify()` 후 `<`를 `\u003c`로 이스케이프
- `products/[slug].tsx`, `symptoms/[slug].tsx` 양쪽 적용

#### 6. 404 응답 처리 (302 → 404)
- 존재하지 않는 제품/증상 slug에 대해 302 리다이렉트 → 404 + 에러 페이지 렌더링
- SEO 관점에서 올바른 시그널 전달

#### 7. seed 스크립트 운영 DB 안전 가드
- `--allow-seed` CLI 플래그 없이 실행 시 경고 메시지 출력 후 종료
- 운영 DB에서 실수로 전체 데이터 삭제 방지

#### 8. JSON-LD Schema 타입 수정
- `symptoms/[slug].tsx`: `@type: "Drug"` → `@type: "DietarySupplement"`
- 영양제는 의약품이 아니므로 DietarySupplement가 적절

### Medium (8건)

#### 9. `any` → `unknown` (utils.ts)
- `State` 인터페이스의 인덱스 시그니처: `[key: string]: any` → `[key: string]: unknown`
- CLAUDE.md의 "`any` 금지" 규칙 준수

#### 10. scaffold 코드 제거
- `main.ts`: 예시 미들웨어, `/api2/:name` 라우트, 로깅 미들웨어 제거
- `routes/api/[name].tsx`: Fresh 기본 API 라우트 삭제 (라우트 충돌 방지)
- `islands/Counter.tsx`, `components/Button.tsx`: 미사용 scaffold 파일 삭제

#### 11. 스키마 SQL 단일 소스
- `create-schema.ts`: 인라인 SQL 120줄 제거, `schema.sql` 파일을 읽도록 변경
- `import.meta.url` 기반 경로로 CWD 의존성 제거
- 미사용 `executeSql` 함수 제거

#### 12. FK CASCADE 추가
- `product_ingredients.ingredient_id`: `ON DELETE CASCADE` 추가
- `ingredient_symptoms.ingredient_id`, `symptom_id`: `ON DELETE CASCADE` 추가

#### 13. BASE_URL 환경변수화
- `sitemap.xml.ts`: 하드코딩 → `Deno.env.get("BASE_URL")` (폴백 포함)
- `robots.txt`: 정적 파일 → 동적 라우트(`routes/robots.txt.ts`)로 변환

#### 14. `State.shared` 필드 제거
- `shared: string` 필드 제거 (설정하는 미들웨어가 삭제되어 불필요)

#### 15. 벡터 인덱스 통합
- `schema.sql`에 벡터 검색 인덱스 추가 (기존 `create-schema.ts`에만 있었음)

---

## 커밋 이력

| 커밋 | 내용 |
|------|------|
| `2ffad55` | fix: address code review findings (security, XSS, cleanup) |
| `5862d64` | fix: address remaining review findings |

---

## 리뷰 후 남은 Low 이슈 (후속 처리)

- `safeJsonLd` 함수가 2개 파일에 중복 → 공통 유틸로 추출 권장
- `routes/api/products/[slug].ts`에 `console.error` 로깅 누락
- `schema.sql` CREATE POLICY에 `IF NOT EXISTS` 없어 멱등성 부족
